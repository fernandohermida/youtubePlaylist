<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIVEPULSE-3000 ◈ Channel Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* ═══ RESET ═══════════════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* ═══ VARIABLES ═══════════════════════════════════════════════ */
    :root {
      --bg:           #080808;
      --surface:      #0e0e0c;
      --bezel:        #1a1812;
      --bezel-hi:     #28241a;
      --bezel-edge:   #322e22;
      --screen:       #060c04;
      --amber:        #ffb300;
      --amber-dim:    #a07200;
      --amber-glow:   rgba(255,179,0,0.35);
      --green:        #39ff14;
      --green-dim:    #1a8a00;
      --phosphor:     #c8c8a0;
      --phosphor-dim: #6a6a50;
      --phosphor-faint: #2e2e20;
      --mono:  'Share Tech Mono', 'Courier New', monospace;
      --brand: 'Orbitron', 'Share Tech Mono', monospace;
    }

    /* ═══ BODY ════════════════════════════════════════════════════ */
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--mono);
      background: var(--bg);
      color: var(--phosphor);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Global heavy scanlines */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.06) 2px,
        rgba(0,0,0,0.06) 4px
      );
      pointer-events: none;
      z-index: 9000;
    }

    /* Global CRT vignette */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.65) 100%);
      pointer-events: none;
      z-index: 9001;
    }

    /* ═══ HEADER ══════════════════════════════════════════════════ */
    .tv-header {
      background: linear-gradient(180deg, #141210 0%, #0e0e0c 100%);
      border-bottom: 2px solid var(--bezel-edge);
      box-shadow: 0 4px 24px rgba(0,0,0,0.8), 0 1px 0 rgba(255,179,0,0.06);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Amber accent stripe */
    .header-stripe {
      height: 2px;
      background: linear-gradient(90deg,
        transparent 0%,
        var(--amber-dim) 15%,
        var(--amber) 40%,
        var(--green) 60%,
        var(--amber) 75%,
        var(--amber-dim) 90%,
        transparent 100%
      );
      opacity: 0.7;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 24px 12px;
    }

    /* Brand / Logo */
    .tv-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .brand-text { line-height: 1; }

    .brand-name {
      font-family: var(--brand);
      font-size: 0.95rem;
      font-weight: 900;
      color: var(--amber);
      letter-spacing: 0.06em;
      text-shadow: 0 0 16px var(--amber-glow), 0 0 40px rgba(255,179,0,0.15);
      white-space: nowrap;
    }

    .brand-sub {
      display: block;
      font-size: 0.48rem;
      color: var(--phosphor-faint);
      letter-spacing: 0.28em;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* On Air indicator */
    .on-air {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.6rem;
      letter-spacing: 0.22em;
      color: var(--green);
      text-shadow: 0 0 10px var(--green);
      border: 1px solid rgba(57,255,20,0.25);
      background: rgba(57,255,20,0.04);
      padding: 5px 12px;
      border-radius: 2px;
    }

    .blink-dot {
      width: 7px;
      height: 7px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--green);
      animation: blink 1.1s step-end infinite;
      flex-shrink: 0;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* Sync time display */
    .header-sync {
      text-align: right;
      flex-shrink: 0;
    }
    .header-sync-label {
      font-size: 0.46rem;
      color: var(--phosphor-faint);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      display: block;
      margin-bottom: 3px;
    }
    .header-sync-value {
      font-size: 0.68rem;
      color: var(--amber);
      letter-spacing: 0.08em;
      text-shadow: 0 0 10px rgba(255,179,0,0.4);
    }

    /* ═══ MAIN ════════════════════════════════════════════════════ */
    main {
      max-width: 1140px;
      margin: 0 auto;
      padding: 32px 20px 64px;
    }

    /* ═══ FEED ════════════════════════════════════════════════════ */
    #feed {
      flex-direction: column;
      gap: 44px;
    }

    /* ═══ PLAYLIST PANEL (TV BEZEL) ═══════════════════════════════ */
    .playlist-panel {
      background: var(--bezel);
      border-radius: 8px;
      border: 2px solid var(--bezel-edge);
      box-shadow:
        0 0 0 1px #0a0906,
        0 12px 48px rgba(0,0,0,0.8),
        0 2px 0 rgba(255,255,255,0.02) inset,
        0 -1px 0 rgba(0,0,0,0.5) inset;
      overflow: hidden;
      opacity: 0;
      animation: panel-rise 0.6s cubic-bezier(0.22,1,0.36,1) forwards;
    }
    @keyframes panel-rise {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Live panel gets amber glow */
    .playlist-panel.is-live {
      border-color: var(--amber-dim);
      box-shadow:
        0 0 0 1px #0a0906,
        0 12px 48px rgba(0,0,0,0.8),
        0 0 32px rgba(255,179,0,0.12),
        0 2px 0 rgba(255,255,255,0.02) inset;
    }

    /* ─── Panel header ─── */
    .panel-header {
      display: flex;
      align-items: stretch;
      background: linear-gradient(180deg, #141210 0%, #0e0e0a 100%);
      border-bottom: 2px solid var(--bezel-hi);
      min-height: 78px;
    }

    /* Thumbnail strip */
    .panel-thumb {
      width: 110px;
      flex-shrink: 0;
      border-right: 1px solid var(--bezel-hi);
      overflow: hidden;
      background: #080806;
      position: relative;
    }
    .panel-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(0.5) brightness(0.75);
    }
    .panel-thumb-ph {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Panel info */
    .panel-info {
      flex: 1;
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 7px;
    }
    .panel-category {
      font-size: 0.46rem;
      color: var(--phosphor-faint);
      letter-spacing: 0.28em;
      text-transform: uppercase;
    }
    .panel-name {
      font-family: var(--brand);
      font-size: 1rem;
      font-weight: 700;
      color: var(--phosphor);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      line-height: 1.1;
    }
    .panel-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .live-badge {
      font-size: 0.58rem;
      letter-spacing: 0.12em;
      padding: 3px 9px;
      border-radius: 2px;
      border: 1px solid;
      white-space: nowrap;
    }
    .live-badge.active {
      color: var(--amber);
      border-color: var(--amber-dim);
      background: rgba(255,179,0,0.07);
      text-shadow: 0 0 8px var(--amber-glow);
      animation: amber-pulse 2.4s ease-in-out infinite;
    }
    .live-badge.inactive {
      color: var(--phosphor-faint);
      border-color: var(--bezel-hi);
      background: transparent;
    }
    @keyframes amber-pulse {
      0%, 100% { box-shadow: none; opacity: 1; }
      50%       { box-shadow: 0 0 12px rgba(255,179,0,0.3); opacity: 0.85; }
    }

    .open-btn {
      font-size: 0.54rem;
      color: var(--phosphor-dim);
      letter-spacing: 0.15em;
      text-decoration: none;
      border: 1px solid var(--bezel-hi);
      padding: 3px 9px;
      border-radius: 2px;
      transition: color 0.15s, border-color 0.15s, background 0.15s;
    }
    .open-btn:hover {
      color: var(--amber);
      border-color: var(--amber-dim);
      background: rgba(255,179,0,0.05);
    }

    /* Counter block (right side of header) */
    .panel-counter {
      flex-shrink: 0;
      border-left: 1px solid var(--bezel-hi);
      padding: 12px 22px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: #080806;
      min-width: 64px;
    }
    .counter-num {
      font-family: var(--brand);
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--amber);
      text-shadow: 0 0 18px var(--amber-glow);
      line-height: 1;
    }
    .counter-label {
      font-size: 0.42rem;
      color: var(--phosphor-faint);
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }

    /* ─── Channel grid area ─── */
    .panel-body {
      padding: 16px;
      background: #09090700;
    }

    /* ═══ CHANNEL GRID ════════════════════════════════════════════ */
    .ch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1px;
      background: var(--bezel-hi);
      border: 1px solid var(--bezel-hi);
      border-radius: 3px;
      overflow: hidden;
    }

    /* ═══ CHANNEL CARD (EPG Flat Tile) ════════════════════════════ */
    .ch-card {
      position: relative;
      display: flex;
      align-items: stretch;
      height: 44px;
      background: var(--surface);
      cursor: pointer;
      text-decoration: none;
      overflow: hidden;
      transition: background 0.08s;
    }

    .ch-card:hover {
      background: var(--amber);
      z-index: 1;
    }

    /* Channel number column */
    .ch-num {
      flex-shrink: 0;
      width: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #16110a;
      border-right: 1px solid var(--bezel-hi);
      font-size: 0.6rem;
      font-weight: bold;
      color: var(--amber-dim);
      letter-spacing: 0.03em;
      transition: background 0.08s, color 0.08s, border-color 0.08s;
    }

    .ch-card:hover .ch-num {
      background: rgba(0,0,0,0.15);
      color: #1a0e00;
      border-right-color: rgba(0,0,0,0.18);
    }

    /* Channel name */
    .ch-name {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-size: 0.68rem;
      color: var(--phosphor);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      transition: color 0.08s;
    }

    .ch-card:hover .ch-name {
      color: #0a0800;
    }

    /* "▶ TUNE IN" hint */
    .ch-tune {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding-right: 10px;
      font-size: 0.42rem;
      letter-spacing: 0.18em;
      color: transparent;
      transition: color 0.08s;
    }

    .ch-card:hover .ch-tune {
      color: rgba(0,0,0,0.42);
    }

    /* ═══ STATE SCREENS ══════════════════════════════════════════ */
    .state-wrap {
      flex-direction: column;
      align-items: center;
      gap: 22px;
      text-align: center;
      padding: 100px 16px;
    }

    @keyframes noise-shift {
      0%   { background-position: 0 0;      }
      50%  { background-position: 5px -3px; }
      100% { background-position: -3px 4px; }
    }

    /* Retro static block for loading / error / empty */
    .tv-static {
      width: 128px;
      height: 96px;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 150' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      background-size: 100% 100%;
      border-radius: 8px;
      border: 2px solid var(--bezel-hi);
      opacity: 0.28;
      animation: noise-shift 0.12s steps(3) infinite;
      box-shadow: inset 0 0 24px rgba(0,0,0,0.9), 0 0 0 1px #050503;
    }

    .state-msg {
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .state-msg.loading-msg {
      color: var(--phosphor-dim);
      animation: flicker 3.5s ease-in-out infinite;
    }
    .state-msg.error-msg   { color: var(--amber); }
    .state-msg.empty-msg   { color: var(--phosphor-faint); }

    @keyframes flicker {
      0%, 90%, 100% { opacity: 1; }
      91%           { opacity: 0.3; }
      92%           { opacity: 0.9; }
      93%           { opacity: 0.2; }
      94%           { opacity: 0.85; }
    }

    /* Animated ellipsis */
    .dots::after {
      content: '';
      animation: ellipsis 1.8s steps(4, end) infinite;
    }
    @keyframes ellipsis {
      0%   { content: ''; }
      25%  { content: '.'; }
      50%  { content: '..'; }
      75%  { content: '...'; }
    }

    /* ═══ FOOTER ═════════════════════════════════════════════════ */
    footer {
      text-align: center;
      padding: 0 16px 48px;
      font-size: 0.52rem;
      color: var(--phosphor-faint);
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }

    /* ═══ RESPONSIVE ═════════════════════════════════════════════ */
    @media (max-width: 640px) {
      .ch-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
      .panel-name { font-size: 0.82rem; }
      .brand-name { font-size: 0.76rem; }
      .panel-thumb { display: none; }
      .header-inner { padding: 10px 14px 12px; }
      .on-air { display: none; }
    }
  </style>
</head>
<body>

  <!-- ══════════════════════════════════════════════════════════ -->
  <!-- HEADER                                                      -->
  <!-- ══════════════════════════════════════════════════════════ -->
  <div class="tv-header">
    <div class="header-stripe"></div>
    <div class="header-inner">

      <!-- Brand -->
      <div class="tv-brand">
        <!-- Antenna SVG -->
        <svg width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
          <line x1="17" y1="30" x2="17" y2="13" stroke="#ffb300" stroke-width="2" stroke-linecap="round"/>
          <line x1="17" y1="13" x2="4"  y2="4"  stroke="#ffb300" stroke-width="1.5" stroke-linecap="round"/>
          <line x1="17" y1="13" x2="30" y2="4"  stroke="#ffb300" stroke-width="1.5" stroke-linecap="round"/>
          <circle cx="17" cy="13" r="2.2" fill="#ffb300" opacity="0.85"/>
          <rect x="11" y="30" width="12" height="3" rx="1.5" fill="#28241a"/>
          <path d="M11 10 Q17 6 23 10" stroke="#ffb300" stroke-width="0.9" fill="none" opacity="0.45"/>
          <path d="M7 7  Q17 2 27 7"  stroke="#ffb300" stroke-width="0.9" fill="none" opacity="0.2"/>
        </svg>
        <div class="brand-text">
          <span class="brand-name">LIVEPULSE&#8209;3000</span>
          <span class="brand-sub">Channel Monitor System</span>
        </div>
      </div>

      <!-- On Air -->
      <div class="on-air">
        <span class="blink-dot"></span>
        ON AIR
      </div>

      <!-- Sync info -->
      <div class="header-sync">
        <span class="header-sync-label">Last Sync</span>
        <span class="header-sync-value" id="last-sync-label">——————</span>
      </div>

    </div>
  </div>

  <!-- ══════════════════════════════════════════════════════════ -->
  <!-- MAIN                                                        -->
  <!-- ══════════════════════════════════════════════════════════ -->
  <main>

    <div id="state-loading" class="state-wrap" style="display:flex">
      <div class="tv-static"></div>
      <p class="state-msg loading-msg"><span class="dots">ACQUIRING SIGNAL</span></p>
    </div>

    <div id="state-error" class="state-wrap" style="display:none">
      <div class="tv-static"></div>
      <p class="state-msg error-msg" id="error-msg">SIGNAL LOST</p>
    </div>

    <div id="state-empty" class="state-wrap" style="display:none">
      <div class="tv-static"></div>
      <p class="state-msg empty-msg">NO BROADCAST DATA &mdash; AWAITING FIRST SYNC</p>
    </div>

    <div id="feed" style="display:none"></div>

  </main>

  <footer id="footer"></footer>

  <!-- ══════════════════════════════════════════════════════════ -->
  <!-- SCRIPT                                                      -->
  <!-- ══════════════════════════════════════════════════════════ -->
  <script>
    /* ── Helpers ─────────────────────────────────────────────── */
    function el(tag, attrs) {
      var children = Array.prototype.slice.call(arguments, 2);
      var node = document.createElement(tag);
      if (attrs) {
        Object.keys(attrs).forEach(function(k) {
          var v = attrs[k];
          if      (k === 'className') node.className = v;
          else if (k === 'onclick')   node.onclick = v;
          else                        node.setAttribute(k, v);
        });
      }
      children.forEach(function(c) {
        if (c == null) return;
        node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      });
      return node;
    }

    function fmtDate(iso) {
      if (!iso) return '——————';
      try {
        return new Date(iso)
          .toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' })
          .toUpperCase();
      } catch(e) { return String(iso).toUpperCase(); }
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    /* ── Build one channel card ──────────────────────────────── */
    function buildChannelCard(ch, idx) {
      var name    = ch.name || ch.id;
      var liveUrl = 'https://www.youtube.com/channel/' + ch.id + '/live';

      var card = el('a', {
        className: 'ch-card',
        href:      liveUrl,
        target:    '_blank',
        rel:       'noopener noreferrer',
        title:     'Tune in: ' + name
      });

      /* Left: channel number column */
      card.appendChild(el('span', { className: 'ch-num' }, 'CH ' + pad2(idx + 1)));
      /* Center: channel name */
      card.appendChild(el('span', { className: 'ch-name' }, name));
      /* Right: tune-in hint (visible on hover) */
      card.appendChild(el('span', { className: 'ch-tune' }, '\u25b6 TUNE IN'));

      return card;
    }

    /* ── Build one playlist panel ────────────────────────────── */
    function buildPlaylistPanel(p, panelIdx) {
      var isLive   = p.liveStreamsFound > 0;
      var channels = p.channels || [];

      /* ─ Panel wrapper ─ */
      var panel = el('div', {
        className: 'playlist-panel' + (isLive ? ' is-live' : ''),
        style: 'animation-delay:' + (panelIdx * 0.15) + 's'
      });

      /* ─ Header ─ */
      var header = el('div', { className: 'panel-header' });

      /* Thumbnail strip */
      var thumb = el('div', { className: 'panel-thumb' });
      if (p.thumbnailUrl) {
        thumb.appendChild(el('img', { src: p.thumbnailUrl, alt: p.name, loading: 'lazy' }));
      } else {
        /* Placeholder — small static block */
        var phWrap = el('div', { className: 'panel-thumb-ph' });
        var phNs = 'http://www.w3.org/2000/svg';
        var phSvg = document.createElementNS(phNs, 'svg');
        phSvg.setAttribute('width', '36'); phSvg.setAttribute('height', '28');
        phSvg.setAttribute('viewBox', '0 0 36 28'); phSvg.setAttribute('fill', 'none');
        var phBg = document.createElementNS(phNs, 'rect');
        phBg.setAttribute('width', '36'); phBg.setAttribute('height', '28');
        phBg.setAttribute('fill', '#0e0e0a');
        var phPoly = document.createElementNS(phNs, 'polygon');
        phPoly.setAttribute('points', '13,10 26,14 13,18');
        phPoly.setAttribute('fill', '#2a2418');
        phSvg.appendChild(phBg); phSvg.appendChild(phPoly);
        phWrap.appendChild(phSvg);
        thumb.appendChild(phWrap);
      }
      header.appendChild(thumb);

      /* Info block */
      var info = el('div', { className: 'panel-info' });
      info.appendChild(el('span', { className: 'panel-category' }, 'Playlist'));
      info.appendChild(el('div',  { className: 'panel-name' }, p.name));

      var actions = el('div', { className: 'panel-actions' });
      var badgeText = isLive ? ('\u25cf ' + p.liveStreamsFound + ' LIVE') : '\u25cb OFFLINE';
      actions.appendChild(el('span', {
        className: 'live-badge ' + (isLive ? 'active' : 'inactive')
      }, badgeText));
      actions.appendChild(el('a', {
        className: 'open-btn',
        href:      p.youtubeUrl,
        target:    '_blank',
        rel:       'noopener noreferrer'
      }, '\u25b6 OPEN PLAYLIST'));
      info.appendChild(actions);
      header.appendChild(info);

      /* Channel counter */
      var counter = el('div', { className: 'panel-counter' });
      counter.appendChild(el('div', { className: 'counter-num' },   String(channels.length)));
      counter.appendChild(el('div', { className: 'counter-label' }, 'Channels'));
      header.appendChild(counter);

      panel.appendChild(header);

      /* ─ Channel grid body ─ */
      var body = el('div', { className: 'panel-body' });
      var grid = el('div', { className: 'ch-grid' });
      channels.forEach(function(ch, i) {
        grid.appendChild(buildChannelCard(ch, i));
      });
      body.appendChild(grid);
      panel.appendChild(body);

      return panel;
    }

    /* ── State switcher ──────────────────────────────────────── */
    function show(id) {
      ['state-loading', 'state-error', 'state-empty', 'feed'].forEach(function(s) {
        var node = document.getElementById(s);
        if (!node) return;
        node.style.display = (s === id) ? 'flex' : 'none';
      });
    }

    /* ── Fetch and render ────────────────────────────────────── */
    fetch('/api/status')
      .then(function(r) {
        if (!r.ok) return r.json().then(function(b) { throw new Error(b.error || 'HTTP ' + r.status); });
        return r.json();
      })
      .then(function(data) {
        /* Update sync timestamp */
        var syncEl = document.getElementById('last-sync-label');
        syncEl.textContent = data.lastSyncAt ? fmtDate(data.lastSyncAt) : '——————';

        if (!data.playlists || data.playlists.length === 0) {
          show('state-empty');
          return;
        }

        var feed = document.getElementById('feed');
        data.playlists.forEach(function(p, i) {
          feed.appendChild(buildPlaylistPanel(p, i));
        });

        show('feed');
        var ft = document.getElementById('footer');
        if (ft) ft.textContent = 'DATA FETCHED  \u25c8  ' + fmtDate(data.generatedAt);
      })
      .catch(function(err) {
        show('state-error');
        var errEl = document.getElementById('error-msg');
        if (errEl) errEl.textContent = 'SIGNAL LOST \u2014 ' + (err.message || 'UNKNOWN ERROR').toUpperCase();
      });
  </script>

</body>
</html>
